 
## 17.1.代码测试  
**说明：** 在设计阶段就必须考虑所编写代码的可测试性，只有提供足够的测试手段才能全面、高效地发现和解决代码中的各类问题。编写的代码是否可测试，是衡量代码质量的最基本的、 最重要的尺度之一。程序设计过程中(或程序编码完毕后)，必须编写软件模块测试文档，主要应包括:设计思路、程序输入、程序输出和数据结构等。测试是设计的一部分。  

### 【原则 17-1-1】：模块划分清晰，接口明确，耦合度低，有明确输入和输出，否则单元测试实施困难。  
**说明：** 单元测试实施依赖于：  
* 模块间的接口定义清楚、完整、稳定；
* 模块功能的有明确的验收条件（包括：预置条件、输入和预期结果）；
* 模块内部的关键状态和关键数据可以查询，可以修改；
* 模块原子功能的入口唯一；
* 模块原子功能的出口唯一；
* 依赖集中处理：和模块相关的全局变量尽量的少，或者采用某种封装形式。

**执行级别：要求**  
**引用知识（官网，书籍）：**  
>《华为C语言编程规范》

### 【规则 17-1-1】：在编写代码的同时，或者编写代码前，编写单元测试用例验证软件设计/编码的正确。单元测试关注单元的行为而不是实现，避免针对函数的测试。  
**说明：** 应该将被测单元看做一个被测的整体，根据实际资源、进度和质量风险，权衡代码覆盖、补充测试用例的难度、被测对象的稳定程度等，一般情况下建议关注模块/组件的测试，尽量避免针对函数的测试。尽管有时候单个用例只能专注于对某个具体函数的测试，但我们关注的应该是函数的行为而不是其具体实现细节。  

**执行级别：要求**  
**引用知识（官网，书籍）：**  
>《华为C语言编程规范》

### 【规则 17-1-2】：在同一项目组或产品组内，要有一套统一的为集成测试与系统联调准备的调测开关及相应打印函数，并且要有详细的说明。  
**说明：** 本规则是针对项目组或产品组的。代码至始至终只有一份代码，不存在开发版本和测试版本的说法。测试与最终发行的版本是通过编译开关的不同来实现的。并且编译开关要规范统一。统一使用编译开关来实现测试版本与发行版本的区别，一般不允许再定义其它新的编译开关。  

**执行级别：要求**  
**引用知识（官网，书籍）：**  
>《华为C语言编程规范》


### 【规则 17-1-3】：在同一项目组或产品组内，调测打印的日志要有统一的规定。  
**说明：** 统一的调测日志记录便于集成测试，具体包括：  
* 统一的日志分类以及日志级别； 
* 通过命令行等方式可以配置和改变日志输出的内容和格式； 
* 在关键分支要记录日志，日志建议不要记录在原子函数中，否则难以定位； 
* 调试日志记录的内容需要包括文件名/模块名、代码行号、函数名、被调用函数名、错误码、错误发生的环境等。

**执行级别：要求**  
**引用知识（官网，书籍）：**  
>《华为C语言编程规范》

### 【规则 17-1-4】：使用断言记录内部假设。  
**说明：** 断言是对某种内部模块的假设条件进行检查，如果假设不成立，说明存在编程、设计错误。断言可以对在系统中隐藏很深，用其它手段极难发现的问题进行定位，从而缩短软件问题定位时间，提高系统的可测性。  

示例：下面是C语言中的一个断言，用宏来设计的。（其中NULL为0L）  
```c
#ifdef _EXAM_ASSERT_TEST_  // 若使用断言测试  
void exam_assert(char * file_name, unsigned int line_no )  
{  
   printf( "\n[EXAM]Assert failed: %s, line %u\n",  
           file_name, line_no );  
    abort();  
}  
#define EXAM_ASSERT( condition )  
    if (condition) // 若条件成立，则无动作  
       NULL;  
    else  // 否则报告  
       exam_assert( __FILE__, __LINE__ )   
#else  // 若不使用断言测试  
#define EXAM_ASSERT(condition)  NULL  
#endif  /* end of ASSERT */  
```

**执行级别：要求**  
**引用知识（官网，书籍）：**  
>《华为C语言编程规范》

### 【规则 17-1-5】：不能用断言来检查运行时错误。  
**说明：** 断言是用来处理内部编程或设计是否符合假设；对于可能会发生的且必须处理的情况要写防错程序。   

示例：假如某模块收到通信链路上的消息，则应对消息的合法性进行检查，若消息类别不是通信协议中规定的，则应进行出错处理，之后可用断言报告，如下例。  
```c
int msg_handle(unsigned char msg_name, unsigned char * msg )  
{  
   switch (msg_name)  
    {  
       case MSG_ONE:  
           ... // 消息MSG_ONE处理  
           return MSG_HANDLE_SUCCESS;  
           ... // 其它合法消息处理  
       default:  
           ... // 消息出错处理  
           ASSERT_REPORT( FALSE );  // “合法”消息不成立，报告  
           return MSG_HANDLE_ERROR;  
    }  
}
```
**执行级别：要求**  
**引用知识（官网，书籍）：**  
>《华为C语言编程规范》

## 17.2.代码维护  
### 【规则 17-2-1】：清理、整理或优化后的代码要经过审查及测试。  
**说明：** 对已经发布的程序修改，先提交到分支，经过审查和测试通过后再合并到主分支。  

**执行级别：要求**  
**引用知识（官网，书籍）：**  
>《华为C语言编程规范》

### 【规则 17-2-2】：使用工具软件对代码版本进行维护。  
**说明：** 通过代码库管理工具可以敏捷高效的维护项目，例如git、repo等。  

**执行级别：要求**  
**引用知识（官网，书籍）：**  
>《华为C语言编程规范》
